{"version":3,"sources":["../src/withTable.js"],"names":["PreserveSpaceAfter","Set","PreserveSpaceBefore","insertParagraph","editor","at","text","Transforms","insertNodes","type","children","withText","entry","node","path","result","undefined","parent","Node","wrapNodes","tablePlugin","deleteBackward","deleteFragment","deleteForward","matchCells","selection","Editor","nodes","match","n","content","removeNodes","Path","next","Range","isCollapsed","isInTable","above","start","isStart","currCell","string","preventDeleteCell","operation","pointCallback","nextPoint","unit","cell","cellPath","Point","equals","anchor","nextCell","before","end","after","withTable","normalizeNode"],"mappings":"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","sourcesContent":["import { createContent } from './creator';\r\nimport { isInSameTable } from './utils';\r\nimport { Editor, Transforms, Path, Range, Point, Node } from 'slate';\r\n\r\nconst PreserveSpaceAfter = new Set(['table']);\r\nconst PreserveSpaceBefore = new Set(['table']);\r\n\r\nconst insertParagraph = (editor, at, text = '') => {\r\n  Transforms.insertNodes(\r\n    editor,\r\n    {\r\n      type: 'paragraph',\r\n      children: [{ text }],\r\n    },\r\n    {\r\n      at,\r\n    },\r\n  );\r\n};\r\n\r\nconst withText = (editor, entry) => {\r\n  const [node, path] = entry;\r\n  const { text } = node;\r\n  let result = false;\r\n  if (text !== undefined) {\r\n    const parent = Node.parent(editor, path);\r\n    if (parent && parent.type === 'table_cell') {\r\n      Transforms.wrapNodes(editor, { type: 'paragraph' }, { at: path });\r\n      result = true;\r\n    }\r\n  }\r\n  return result;\r\n};\r\n\r\nconst tablePlugin = editor => {\r\n  const { deleteBackward, deleteFragment, deleteForward } = editor;\r\n  const matchCells = node => node.type === 'table_cell';\r\n\r\n  editor.deleteFragment = (...args) => {\r\n    if (editor.selection && isInSameTable(editor)) {\r\n      const [content] = Editor.nodes(editor, {\r\n        match: n => n.type === 'paragraph',\r\n      });\r\n\r\n      Transforms.insertNodes(editor, createContent(), { at: content[1] });\r\n      Transforms.removeNodes(editor, { at: Path.next(content[1]) });\r\n\r\n      return;\r\n    }\r\n\r\n    Transforms.removeNodes(editor, {\r\n      match: n => n.type === 'table',\r\n    });\r\n\r\n    deleteFragment(...args);\r\n  };\r\n  editor.deleteBackward = (...args) => {\r\n    const selection = editor && editor.selection;\r\n    if (selection) return;\r\n\r\n    if (selection && Range.isCollapsed(selection)) {\r\n      const isInTable = Editor.above(editor, {\r\n        match: n => n.type === 'table',\r\n      });\r\n\r\n      if (isInTable) {\r\n        const start = Editor.start(editor, selection);\r\n        const isStart = Editor.isStart(editor, start, selection);\r\n\r\n        const currCell = Editor.above(editor, {\r\n          match: n => n.type === 'table-cell',\r\n        });\r\n\r\n        if (isStart && currCell && !Editor.string(editor, currCell[1])) {\r\n          return;\r\n        }\r\n      }\r\n    }\r\n\r\n    deleteBackward(...args);\r\n  };\r\n\r\n  const preventDeleteCell = (operation, pointCallback, nextPoint) => unit => {\r\n    const selection = editor && editor.selection;\r\n    if (!selection) return;\r\n\r\n    if (Range.isCollapsed(selection)) {\r\n      const [cell] = Editor.nodes(editor, {\r\n        match: matchCells,\r\n      });\r\n      if (cell) {\r\n        // Prevent deletions within a cell\r\n        const [, cellPath] = cell;\r\n        const start = pointCallback(editor, cellPath);\r\n\r\n        if (selection && Point.equals(selection.anchor, start)) {\r\n          return;\r\n        }\r\n      } else {\r\n        // Prevent deleting cell when selection is before or after a table\r\n        const next = nextPoint(editor, selection, { unit });\r\n        const [nextCell] = Editor.nodes(editor, {\r\n          match: matchCells,\r\n          at: next,\r\n        });\r\n        if (nextCell) return;\r\n      }\r\n    }\r\n\r\n    operation(unit);\r\n  };\r\n\r\n  // prevent deleting cells with deleteBackward\r\n  editor.deleteBackward = preventDeleteCell(deleteBackward, Editor.start, Editor.before);\r\n\r\n  // prevent deleting cells with deleteForward\r\n  editor.deleteForward = preventDeleteCell(deleteForward, Editor.end, Editor.after);\r\n\r\n  return editor;\r\n};\r\n\r\nconst withTable = editor => {\r\n  const { normalizeNode } = editor;\r\n\r\n  editor.normalizeNode = entry => {\r\n    if (withText(editor, entry)) return;\r\n\r\n    normalizeNode(entry);\r\n  };\r\n\r\n  return tablePlugin(editor);\r\n};\r\n\r\nexport default withTable;\r\n"],"file":"withTable.js"}