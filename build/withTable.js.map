{"version":3,"sources":["../src/withTable.js"],"names":["PreserveSpaceAfter","Set","PreserveSpaceBefore","insertParagraph","editor","at","text","Transforms","insertNodes","type","children","maybePreserveSpace","entry","node","path","preserved","has","next","Editor","Path","length","prev","previous","tablePlugin","deleteBackward","deleteFragment","selection","nodes","match","n","content","removeNodes","Range","isCollapsed","isInTable","above","start","isStart","currCell","string","withTable","normalizeNode"],"mappings":"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","sourcesContent":["import { Editor, Transforms, Path, Range } from 'slate';\r\nimport { createContent } from './creator';\r\nimport { isInSameTable } from './utils';\r\n\r\nconst PreserveSpaceAfter = new Set(['table']);\r\nconst PreserveSpaceBefore = new Set(['table']);\r\n\r\nconst insertParagraph = (\r\n  editor,\r\n  at,\r\n  text = '',\r\n) => {\r\n  Transforms.insertNodes(\r\n    editor,\r\n    {\r\n      type: 'paragraph',\r\n      children: [{ text }],\r\n    },\r\n    {\r\n      at,\r\n    },\r\n  );\r\n};\r\n\r\nconst maybePreserveSpace = (\r\n  editor,\r\n  entry,\r\n) => {\r\n  const [node, path] = entry;\r\n  const { type } = node;\r\n  let preserved = false;\r\n\r\n  if (PreserveSpaceAfter.has(type)) {\r\n    const next = Editor.next(editor, { at: path });\r\n    if (!next || PreserveSpaceBefore.has(next[0].type)) {\r\n      insertParagraph(editor, Path.next(path));\r\n      preserved = true;\r\n    }\r\n  }\r\n\r\n  if (PreserveSpaceBefore.has(type)) {\r\n    if (path[path.length - 1] === 0) {\r\n      insertParagraph(editor, path);\r\n      preserved = true;\r\n    } else {\r\n      const prev = Editor.previous(editor, { at: path });\r\n      if (!prev || PreserveSpaceAfter.has(prev[0].type)) {\r\n        insertParagraph(editor, path);\r\n        preserved = true;\r\n      }\r\n    }\r\n  }\r\n\r\n  return preserved;\r\n};\r\n\r\nconst tablePlugin = (editor) => {\r\n  const { deleteBackward, deleteFragment } = editor;\r\n\r\n  editor.deleteFragment = (...args) => {\r\n    if (editor.selection && isInSameTable(editor)) {\r\n      const [content] = Editor.nodes(editor, {\r\n        match: n => n.type === 'paragraph',\r\n      });\r\n\r\n      Transforms.insertNodes(editor, createContent(), { at: content[1] });\r\n      Transforms.removeNodes(editor, { at: Path.next(content[1]) });\r\n\r\n      return;\r\n    }\r\n\r\n    Transforms.removeNodes(editor, {\r\n      match: n => n.type === 'table',\r\n    });\r\n\r\n    deleteFragment(...args);\r\n  };\r\n  editor.deleteBackward = (...args) => {\r\n    const { selection } = editor;\r\n    if (selection && Range.isCollapsed(selection)) {\r\n      const isInTable = Editor.above(editor, {\r\n        match: n => n.type === 'table',\r\n      });\r\n\r\n      if (isInTable) {\r\n        const start = Editor.start(editor, selection);\r\n        const isStart = Editor.isStart(editor, start, selection);\r\n\r\n        const currCell = Editor.above(editor, {\r\n          match: n => n.type === 'table-cell',\r\n        });\r\n\r\n        if (isStart && currCell && !Editor.string(editor, currCell[1])) {\r\n          return;\r\n        }\r\n      }\r\n    }\r\n\r\n    deleteBackward(...args);\r\n  };\r\n\r\n  return editor;\r\n};\r\n\r\n\r\nconst withTable = (editor) => {\r\n  const { normalizeNode } = editor;\r\n\r\n  editor.normalizeNode = entry => {\r\n    if (maybePreserveSpace(editor, entry)) return;\r\n\r\n    normalizeNode(entry);\r\n  };\r\n\r\n  return tablePlugin(editor);\r\n};\r\n\r\nexport default withTable;\r\n"],"file":"withTable.js"}