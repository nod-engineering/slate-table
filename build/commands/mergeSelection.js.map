{"version":3,"sources":["../../src/commands/mergeSelection.js"],"names":["checkMerge","table","startCell","direction","startCellKey","key","selectedTable","startCellKeyIndexInTable","isMergeDown","forEach","row","findIndex","obj","cell","length","push","mergeSelection","editor","selection","Editor","edges","start","nodes","match","n","type","at","startNode","gridTable","downIndex","insertPositionCol","tmpContent","col","isReal","node","string","children","Transforms","removeNodes","setNodes","height","width","colspan","rowspan","rows","minRowHeight","Infinity","mergedGridTable","idx","allColumnIsReal","minColWidth","j","originPath","insertContents","Object","values","content","insertNodes","end"],"mappings":"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","sourcesContent":["/* eslint-disable no-restricted-syntax */\n/* eslint-disable consistent-return */\nimport { Editor, Transforms } from 'slate';\nimport { splitedTable } from '../selection';\n\nexport function checkMerge(table, startCell, direction) {\n  const startCellKey = startCell[0].key;\n  const selectedTable = [[]];\n  let startCellKeyIndexInTable = -1;\n  const isMergeDown = direction === 'down';\n  table.forEach(row => {\n    startCellKeyIndexInTable = isMergeDown && startCellKeyIndexInTable !== -1 ? startCellKeyIndexInTable : row.findIndex(obj => obj.cell.key === startCellKey);\n    if (direction === 'right') {\n      if (startCellKeyIndexInTable !== -1 && row.length > startCellKeyIndexInTable + 1) {\n        selectedTable[0].push(row[startCellKeyIndexInTable], row[startCellKeyIndexInTable + 1]);\n      }\n    }\n    if (isMergeDown) {\n      if (startCellKeyIndexInTable !== -1) {\n        if (selectedTable.length === 1 && selectedTable[0].length === 0) {\n          selectedTable[0].push(row[startCellKeyIndexInTable]);\n        } else {\n          selectedTable.push([row[startCellKeyIndexInTable]]);\n        }\n      }\n    }\n  });\n  return selectedTable;\n}\n\n\nconst mergeSelection = (table, editor, direction = 'right') => {\n  if (!table || !editor.selection) return;\n  const [start] = Editor.edges(editor, editor.selection);\n  const [startNode] = Editor.nodes(editor, {\n    match: n => n.type === 'table_cell',\n    at: start,\n  });\n  const { key } = startNode[0];\n  const { gridTable } = splitedTable(editor, table, key);\n  const [startCell] = Editor.nodes(editor, {\n    match: n => n.key === key,\n    at: [],\n  });\n\n  if (!startCell) return;\n  const isMergeDown = direction === 'down';\n  const selectedTable = checkMerge(gridTable, startCell, direction);\n  if (!selectedTable) return;\n  const downIndex = selectedTable.length - 1;\n  const insertPositionCol = isMergeDown ? selectedTable[downIndex][0] : selectedTable[0][1];\n  const tmpContent = {};\n\n  gridTable.forEach((row) => {\n    row.forEach((col) => {\n      if (col.cell.key === insertPositionCol.cell.key &&\n        col.isReal\n      ) {\n        const [node] = Editor.nodes(editor, {\n          match: n => n.key === col.cell.key,\n          at: [],\n        });\n        if (node) {\n          if (Editor.string(editor, node[1])) {\n            tmpContent[col.cell.key] = node[0].children;\n          }\n\n          Transforms.removeNodes(editor, {\n            at: table[1],\n            match: n => n.key === col.cell.key,\n          });\n        }\n      }\n    });\n  });\n  Transforms.setNodes(\n    editor,\n    {\n      height: 0,\n      width: 0,\n      colspan: selectedTable[0].length,\n      rowspan: selectedTable.length,\n    },\n    {\n      at: table[1],\n      match: n => n.key === selectedTable[0][0].cell.key,\n    },\n  );\n\n  Transforms.removeNodes(editor, {\n    at: table[1],\n    match: n => {\n      if (n.type !== 'table_row') {\n        return false;\n      }\n\n      if (\n        !n.children ||\n        n.children.findIndex((cell) => cell.type === 'table_cell') < 0\n      ) {\n        return true;\n      }\n\n      return false;\n    },\n  });\n\n  const rows = Editor.nodes(editor, {\n    at: table[1],\n    match: n => n.type === 'table_row',\n  });\n\n  for (const row of rows) {\n    let minRowHeight = Infinity;\n    // eslint-disable-next-line no-loop-func\n    row[0].children.forEach((cell) => {\n      const { rowspan = 1 } = cell;\n      if (rowspan < minRowHeight) {\n        minRowHeight = rowspan;\n      }\n    });\n\n    if (minRowHeight > 1 && minRowHeight < Infinity) {\n      row[0].children.forEach((cell) => {\n        Transforms.setNodes(\n          editor,\n          {\n            height: 0,\n            width: 0,\n            rowspan: (cell.rowspan || 1) - minRowHeight + 1,\n          },\n          {\n            at: table[1],\n            match: n => n.key === cell.key,\n          },\n        );\n      });\n    }\n  }\n  const { gridTable: mergedGridTable } = splitedTable(editor, table);\n  for (let idx = 0; idx < mergedGridTable[0].length; idx += 1) {\n    let allColumnIsReal = true;\n    let minColWidth = Infinity;\n\n    for (let j = 0; j < mergedGridTable.length; j += 1) {\n      // eslint-disable-next-line no-continue\n      if (!mergedGridTable[j][idx]) continue;\n\n      if (!mergedGridTable[j][idx].isReal) {\n        allColumnIsReal = false;\n      } else {\n        const { colspan = 1 } = mergedGridTable[j][idx].cell;\n        if (colspan < minColWidth) {\n          minColWidth = colspan;\n        }\n      }\n    }\n\n    if (allColumnIsReal && minColWidth < Infinity && minColWidth > 1) {\n      for (let j = 0; j < mergedGridTable.length; j += 1) {\n        const { cell } = mergedGridTable[j][idx];\n        Transforms.setNodes(\n          editor,\n          {\n            height: 0,\n            width: 0,\n            colspan: (cell.colspan || 1) - minColWidth + 1,\n          },\n          {\n            at: table[1],\n            match: n => n.key === cell.key,\n          },\n        );\n      }\n    }\n  }\n\n  const [insertContents] = Editor.nodes(editor, {\n    at: selectedTable[0][0].originPath,\n    match: n => n.type === 'paragraph',\n  });\n  Object.values(tmpContent).forEach(content => {\n    if (content[0] && content[0].children) {\n      Transforms.insertNodes(editor, content[0].children, {\n        at: Editor.end(editor, insertContents[1]),\n      });\n    }\n  });\n}\n\nexport default mergeSelection;"],"file":"mergeSelection.js"}